task.wait(2)
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- ‚öôÔ∏è CONFIG
local BOT_TOKEN   = "MTQzNDIxMTY0OTA0NDIyMTk2Mw.GatEhZ.8mRHG7Z625oMELqzErtng9Q6imrjxPGyXdy5J8"
local CHANNEL_ID  = "1431890326536323122"
local PLACE_ID    = 109983668079237
local POLL_INTERVAL = 1.0
local MESSAGES_LIMIT = 5
local MinMoney = 0

-- üîß HTTP ch·ªçn
local http_impl
if typeof(syn) == "table" and typeof(syn.request) == "function" then
	http_impl = syn.request
elseif typeof(http_request) == "function" then
	http_impl = http_request
elseif typeof(request) == "function" then
	http_impl = request
else
	http_impl = function(opt)
		local ok, res = pcall(function() return HttpService:RequestAsync(opt) end)
		if not ok then return {Success=false, Body=tostring(res)} end
		return res
	end
end

local decode = function(body)
	local ok, data = pcall(function() return HttpService:JSONDecode(body) end)
	if ok and type(data) == "table" then return data else return {} end
end

local uuidPattern = "%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x"
local seenJobs, seenMsgs = {}, {}
local enabled = false
local lastTimestamp = 0

-- ‚è∞ parse timestamp ISO ‚Üí epoch
local function parseTimestamp(ts)
	local y,m,d,h,mi,s = ts:match("(%d+)%-(%d+)%-(%d+)T(%d+):(%d+):(%d+)")
	if not y then return 0 end
	return os.time({year=y, month=m, day=d, hour=h, min=mi, sec=s})
end

-- üí∞ l·∫•y s·ªë ti·ªÅn, h·ªó tr·ª£ M v√† B
local function extractMoney(text)
	local m = text:match("%$(%d+%.?%d*)M")
	local b = text:match("%$(%d+%.?%d*)B")
	if b then
		return tonumber(b) * 1000 -- 1B = 1000M
	elseif m then
		return tonumber(m)
	end
	return 0
end

-- üì° l·∫•y tin nh·∫Øn m·ªõi (fix cache cho Delta)
local function getMessages()
	local url = ("https://discord.com/api/v10/channels/%s/messages?limit=%d&_ts=%d"):format(CHANNEL_ID, MESSAGES_LIMIT, math.random(100000,999999))
	local res = http_impl({
		Url = url,
		Method = "GET",
		Headers = {
			["Authorization"] = "Bot " .. BOT_TOKEN,
			["Accept"] = "application/json",
			["Cache-Control"] = "no-cache, no-store, must-revalidate",
			["Pragma"] = "no-cache",
			["Expires"] = "0",
			["User-Agent"] = "CTFinderBot-v9.9"
		}
	})
	if not res or not res.Body then return {} end
	if not (res.Success or (res.StatusCode == 200)) then return {} end
	local data = decode(res.Body)
	table.sort(data, function(a,b)
		return parseTimestamp(a.timestamp or "1970-01-01T00:00:00") < parseTimestamp(b.timestamp or "1970-01-01T00:00:00")
	end)
	return data
end

-- üîç l·ªçc JobId
local function extractJobIds(msg)
	local found = {}
	local content = msg.content or ""
	if msg.embeds then
		for _, e in ipairs(msg.embeds) do
			if e.description then content ..= "\n" .. e.description end
			if e.title then content ..= "\n" .. e.title end
			if e.fields then
				for _, f in ipairs(e.fields) do
					if f.value then content ..= "\n" .. f.value end
				end
			end
		end
	end

	local money = extractMoney(content)
	if money < MinMoney then
		return {}
	end

	for id in string.gmatch(content, uuidPattern) do
		if not seenJobs[id] then
			seenJobs[id] = true
			table.insert(found, id)
		end
	end
	return found
end

-- üöÄ Join Job b·∫±ng script th·ª±c t·∫ø
local function joinJob(jobId)
	print("üåê Join Job:", jobId)
	local cmd = string.format("game:GetService('TeleportService'):TeleportToPlaceInstance(%d, '%s', game.Players.LocalPlayer)", PLACE_ID, jobId)
	print("[‚ñ∂Ô∏è RUN]:", cmd)
	local success, err = pcall(function()
		loadstring(cmd)()
	end)
	if not success then
		warn("‚ö†Ô∏è L·ªói khi ch·∫°y teleport script:", err)
	end
end

-- üîÅ Loop realtime
task.spawn(function()
	while true do
		if enabled then
			local msgs = getMessages()
			for _, m in ipairs(msgs) do
				local ts = parseTimestamp(m.timestamp or "")
				if ts > lastTimestamp and not seenMsgs[m.id] then
					seenMsgs[m.id] = true
					lastTimestamp = ts
					for _, id in ipairs(extractJobIds(m)) do
						joinJob(id)
					end
				end
			end
		end
		task.wait(POLL_INTERVAL)
	end
end)

-- üß± GUI
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "CTFinderUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 260, 0, 130)
frame.Position = UDim2.new(0, 20, 0.65, 0)
frame.BackgroundColor3 = Color3.fromRGB(15, 18, 28)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true

local corner = Instance.new("UICorner", frame)
corner.CornerRadius = UDim.new(0, 12)
local stroke = Instance.new("UIStroke", frame)
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(0, 200, 255)
stroke.Transparency = 0.4
task.spawn(function()
	while task.wait(0.05) do
		stroke.Color = Color3.fromHSV((tick() % 5) / 5, 0.7, 1)
	end
end)

local title = Instance.new("TextLabel", frame)
title.Text = "‚ö° discord.gg/NBnWHSpbjT"
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(0, 200, 255)
title.TextSize = 18
title.BackgroundTransparency = 1
title.Position = UDim2.new(0, 15, 0, 8)
title.Size = UDim2.new(1, -20, 0, 24)
title.TextXAlignment = Enum.TextXAlignment.Left

local status = Instance.new("TextLabel", frame)
status.Text = "Status: OFF"
status.Font = Enum.Font.Gotham
status.TextColor3 = Color3.fromRGB(255, 80, 80)
status.TextSize = 14
status.BackgroundTransparency = 1
status.Position = UDim2.new(0, 15, 0, 36)
status.Size = UDim2.new(1, -20, 0, 22)
status.TextXAlignment = Enum.TextXAlignment.Left

-- √î nh·∫≠p min ti·ªÅn
local moneyLabel = Instance.new("TextLabel", frame)
moneyLabel.Text = "Min $M/s:"
moneyLabel.Font = Enum.Font.GothamBold
moneyLabel.TextSize = 14
moneyLabel.TextColor3 = Color3.fromRGB(255,255,255)
moneyLabel.BackgroundTransparency = 1
moneyLabel.Position = UDim2.new(0,15,0,64)
moneyLabel.Size = UDim2.new(0,80,0,25)

local moneyBox = Instance.new("TextBox", frame)
moneyBox.PlaceholderText = "0"
moneyBox.Text = tostring(MinMoney)
moneyBox.Font = Enum.Font.Gotham
moneyBox.TextSize = 14
moneyBox.TextColor3 = Color3.fromRGB(255,255,255)
moneyBox.BackgroundColor3 = Color3.fromRGB(25,30,45)
moneyBox.Position = UDim2.new(0,95,0,64)
moneyBox.Size = UDim2.new(0,60,0,25)
local mbCorner = Instance.new("UICorner", moneyBox)
mbCorner.CornerRadius = UDim.new(0,6)
moneyBox.FocusLost:Connect(function()
	local v = tonumber(moneyBox.Text)
	if v then MinMoney = v else moneyBox.Text = tostring(MinMoney) end
end)

-- N√∫t b·∫≠t/t·∫Øt
local toggle = Instance.new("TextButton", frame)
toggle.Text = "Turn ON"
toggle.Font = Enum.Font.GothamBold
toggle.TextSize = 14
toggle.Size = UDim2.new(0, 90, 0, 32)
toggle.Position = UDim2.new(1, -105, 1, -45)
toggle.BackgroundColor3 = Color3.fromRGB(30, 120, 255)
toggle.TextColor3 = Color3.fromRGB(255, 255, 255)
toggle.AutoButtonColor = false
local btnCorner = Instance.new("UICorner", toggle)
btnCorner.CornerRadius = UDim.new(0, 8)
local hoverStroke = Instance.new("UIStroke", toggle)
hoverStroke.Thickness = 1.6
hoverStroke.Color = Color3.fromRGB(0, 180, 255)
hoverStroke.Transparency = 0.5

toggle.MouseEnter:Connect(function()
	TweenService:Create(toggle, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 140, 255)}):Play()
end)
toggle.MouseLeave:Connect(function()
	if enabled then
		TweenService:Create(toggle, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(200, 60, 60)}):Play()
	else
		TweenService:Create(toggle, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(30, 120, 255)}):Play()
	end
end)

toggle.MouseButton1Click:Connect(function()
	enabled = not enabled
	if enabled then
		-- üö´ Khi b·∫≠t ON, b·ªè to√†n b·ªô d·ªØ li·ªáu c≈©
		seenMsgs, seenJobs = {}, {}
		toggle.Text = "Turn OFF"
		status.Text = "Status: ON"
		status.TextColor3 = Color3.fromRGB(120, 255, 120)
		TweenService:Create(toggle, TweenInfo.new(0.25), {BackgroundColor3 = Color3.fromRGB(200, 60, 60)}):Play()

		-- üöÄ C·ªë t√¨nh b·ªè qua m·ªçi tin c≈© tr∆∞·ªõc khi b·∫≠t
		lastTimestamp = os.time()

		print("üß† [CT Finder] ƒê√£ reset cache, ch·ªâ ƒë·ªçc tin m·ªõi sau th·ªùi ƒëi·ªÉm n√†y.")
	else
		toggle.Text = "Turn ON"
		status.Text = "Status: OFF"
		status.TextColor3 = Color3.fromRGB(255, 100, 100)
		TweenService:Create(toggle, TweenInfo.new(0.25), {BackgroundColor3 = Color3.fromRGB(30, 120, 255)}):Play()
	end
end)
